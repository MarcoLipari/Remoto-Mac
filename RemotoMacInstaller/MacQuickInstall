set -e

echo " Remoto Mac - Installer"
echo "======================================"

# Check macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    echo "âŒ This script is for macOS only"
    exit 1
fi

# Install Homebrew if needed
if ! command -v brew &> /dev/null; then
    echo "ðŸ“¦ Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    if [[ $(uname -m) == "arm64" ]]; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Install dependencies
echo "ðŸ“¦ Installing dependencies..."
brew list mediamtx &> /dev/null || brew install mediamtx
brew list ffmpeg &> /dev/null || brew install ffmpeg
brew list cloudflared &> /dev/null || brew install cloudflare/cloudflare/cloudflared

# Configure MediaMTX
CONFIG_DIR="/opt/homebrew/etc/mediamtx"
mkdir -p "$CONFIG_DIR"

if [ -f "$CONFIG_DIR/mediamtx.yml" ]; then
    cp "$CONFIG_DIR/mediamtx.yml" "$CONFIG_DIR/mediamtx.yml.backup.$(date +%s)"
fi

cat > "$CONFIG_DIR/mediamtx.yml" << 'EOF'
logLevel: info
logDestinations: [stdout]
readTimeout: 10s
writeTimeout: 10s
writeQueueSize: 512
udpMaxPayloadSize: 1472

authMethod: internal
authInternalUsers:
- user: any
  pass:
  ips: []
  permissions:
  - action: publish
  - action: read
  - action: playback

rtsp: yes
rtspAddress: :8554
rtspTransports: [tcp]
rtspEncryption: "no"

hls: yes
hlsAddress: :8888
hlsEncryption: no
hlsAllowOrigin: '*'
hlsAlwaysRemux: yes
hlsVariant: lowLatency
hlsSegmentCount: 7
hlsSegmentDuration: 1s
hlsPartDuration: 200ms
hlsSegmentMaxSize: 50M
hlsDirectory: ''

rtmp: no
webrtc: no
srt: no
api: no
metrics: no
pprof: no
playback: no

pathDefaults:
  source: publisher
  record: no

paths:
  screen:
    source: publisher
EOF

# Create scripts directory
SCRIPTS_DIR="$HOME/.remoto"
mkdir -p "$SCRIPTS_DIR"

# Create unified start script
cat > "$SCRIPTS_DIR/start.sh" << 'STARTEOF'
#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN} Starting Remoto Streaming System${NC}"
echo "======================================"

# Create log directory
LOG_DIR="$HOME/.remoto/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/remoto-$(date +%Y%m%d-%H%M%S).log"

# Cleanup function
cleanup() {
    echo -e "\n${YELLOW}ðŸ›‘ Stopping all services...${NC}"
    pkill -f "ffmpeg.*rtsp://127.0.0.1:8554/screen" 2>/dev/null
    pkill cloudflared 2>/dev/null
    brew services stop mediamtx 2>/dev/null
    echo -e "${GREEN}âœ… Cleanup complete${NC}"
    exit 0
}

trap cleanup EXIT INT TERM

# Start MediaMTX
echo -e "${GREEN}ðŸ“¡ Starting MediaMTX...${NC}"
brew services start mediamtx
sleep 3

# Auto-detect display (screens only, not cameras)
echo -e "${GREEN}ðŸ–¥ï¸  Auto-detecting displays...${NC}"
DISPLAY_LIST=$(ffmpeg -f avfoundation -list_devices true -i "" 2>&1 | grep -A 20 "AVFoundation video devices")

# Filter for screens only (they contain "Capture screen" in their description)
SCREEN_DEVICES=$(echo "$DISPLAY_LIST" | grep "Capture screen")

echo "Available screens:"
echo "$SCREEN_DEVICES"
echo ""

# Try common display numbers in order (1, 0, 2, 3)
DISPLAY_NUM=""
for num in 1 0 2 3; do
    if echo "$SCREEN_DEVICES" | grep -q "\[$num\].*Capture screen"; then
        DISPLAY_NUM=$num
        SCREEN_NAME=$(echo "$SCREEN_DEVICES" | grep "\[$num\]" | sed 's/.*Capture screen //' | sed 's/\[.*//')
        echo -e "${GREEN}âœ… Using display $DISPLAY_NUM: $SCREEN_NAME${NC}"
        break
    fi
done

if [ -z "$DISPLAY_NUM" ]; then
    echo -e "${RED}âŒ No screen capture device detected${NC}"
    echo "Available devices (including cameras):"
    echo "$DISPLAY_LIST"
    read -p "Enter screen capture device number: " DISPLAY_NUM
fi

# Start FFmpeg in background
echo -e "${GREEN}ðŸŽ¥ Starting screen capture...${NC}"

# Try hardware encoder first
ffmpeg -f avfoundation -pixel_format nv12 -framerate 30 -i "$DISPLAY_NUM" \
    -vf "scale=1920:1080:flags=lanczos,fps=30" \
    -c:v h264_videotoolbox -b:v 3M -allow_sw 1 \
    -g 30 -keyint_min 30 \
    -f rtsp rtsp://127.0.0.1:8554/screen \
    >> "$LOG_FILE" 2>&1 &

FFMPEG_PID=$!
sleep 3

# Check if FFmpeg started successfully
if ! ps -p $FFMPEG_PID > /dev/null; then
    echo -e "${YELLOW}âš ï¸  Hardware encoder failed, trying software encoder...${NC}"
    
    # Fallback to software encoder (slower but more reliable)
    ffmpeg -f avfoundation -pixel_format nv12 -framerate 30 -i "$DISPLAY_NUM" \
        -vf "scale=1920:1080:flags=lanczos,fps=30" \
        -c:v libx264 -preset ultrafast -tune zerolatency \
        -b:v 3M -g 30 -keyint_min 30 \
        -f rtsp rtsp://127.0.0.1:8554/screen \
        >> "$LOG_FILE" 2>&1 &
    
    FFMPEG_PID=$!
    sleep 3
    
    if ! ps -p $FFMPEG_PID > /dev/null; then
        echo -e "${RED}âŒ FFmpeg failed to start. Check logs at: $LOG_FILE${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ… Using software encoder${NC}"
fi

# Start Cloudflare tunnel and capture URL
echo -e "${GREEN}ðŸŒ Starting Cloudflare tunnel...${NC}"
TUNNEL_OUTPUT=$(mktemp)
cloudflared tunnel --url http://localhost:8888 > "$TUNNEL_OUTPUT" 2>&1 &
CLOUDFLARED_PID=$!

# Wait for tunnel URL
echo -e "${YELLOW}â³ Waiting for tunnel URL...${NC}"
COUNTER=0
while [ $COUNTER -lt 30 ]; do
    if grep -q "https://.*\.trycloudflare\.com" "$TUNNEL_OUTPUT"; then
        break
    fi
    sleep 1
    COUNTER=$((COUNTER + 1))
done

# Extract and display URL
TUNNEL_URL=$(grep -o "https://[^[:space:]]*\.trycloudflare\.com" "$TUNNEL_OUTPUT" | head -1)
STREAM_URL="${TUNNEL_URL}/screen"

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘          ðŸŽ‰ Remoto is Running! ðŸŽ‰             â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${YELLOW}ðŸ“º Stream URL:${NC}"
echo -e "${GREEN}${STREAM_URL}${NC}"
echo ""
echo -e "${YELLOW}ðŸ“‹ This URL has been copied to your clipboard!${NC}"
echo ""
echo -e "Paste this URL in the frontend config 'Livestream URL' field"
echo ""
echo -e "${YELLOW}ðŸ’¡ Press Ctrl+C to stop all services${NC}"
echo -e "${YELLOW}ðŸ“ Logs: $LOG_FILE${NC}"
echo ""

# Copy to clipboard
echo -n "$STREAM_URL" | pbcopy

# Keep script running
tail -f "$LOG_FILE" &
wait $FFMPEG_PID
STARTEOF

chmod +x "$SCRIPTS_DIR/start.sh"

# Create stop script
cat > "$SCRIPTS_DIR/stop.sh" << 'STOPEOF'
#!/bin/bash

echo "ðŸ›‘ Stopping Remoto services..."
pkill -f "ffmpeg.*rtsp://127.0.0.1:8554/screen"
pkill cloudflared
brew services stop mediamtx
echo "âœ… All services stopped"
STOPEOF

chmod +x "$SCRIPTS_DIR/stop.sh"

# Create status script
cat > "$SCRIPTS_DIR/status.sh" << 'STATUSEOF'
#!/bin/bash

echo "ðŸ“Š Remoto Status"
echo "================"

echo -n "MediaMTX: "
if brew services list | grep mediamtx | grep -q started; then
    echo "âœ… Running"
else
    echo "âŒ Stopped"
fi

echo -n "FFmpeg: "
if pgrep -f "ffmpeg.*rtsp://127.0.0.1:8554/screen" > /dev/null; then
    echo "âœ… Running (PID: $(pgrep -f 'ffmpeg.*rtsp://127.0.0.1:8554/screen'))"
else
    echo "âŒ Stopped"
fi

echo -n "Cloudflared: "
if pgrep cloudflared > /dev/null; then
    echo "âœ… Running (PID: $(pgrep cloudflared))"
else
    echo "âŒ Stopped"
fi
STATUSEOF

chmod +x "$SCRIPTS_DIR/status.sh"

# Create LaunchAgent for auto-start (optional)
cat > "$SCRIPTS_DIR/install-autostart.sh" << 'AUTOEOF'
#!/bin/bash

PLIST_PATH="$HOME/Library/LaunchAgents/com.remoto.streaming.plist"

cat > "$PLIST_PATH" << 'PLISTEOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.remoto.streaming</string>
    <key>ProgramArguments</key>
    <array>
        <string>REPLACE_HOME/.remoto/start.sh</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>
</dict>
</plist>
PLISTEOF

# Replace placeholder with actual home directory
sed -i '' "s|REPLACE_HOME|$HOME|g" "$PLIST_PATH"

launchctl load "$PLIST_PATH"
echo "âœ… Auto-start enabled. Remoto will start on login."
echo "To disable: launchctl unload $PLIST_PATH"
AUTOEOF

chmod +x "$SCRIPTS_DIR/install-autostart.sh"

# Add to PATH if needed
if [[ ":$PATH:" != *":$SCRIPTS_DIR:"* ]]; then
    echo "export PATH=\"\$PATH:$SCRIPTS_DIR\"" >> ~/.zshrc
    echo "âš ï¸  Restart your terminal or run: source ~/.zshrc"
fi

# Create desktop shortcuts
cat > "$HOME/Desktop/Start Remoto.command" << EOF
#!/bin/bash
cd "$SCRIPTS_DIR"
./start.sh
EOF

chmod +x "$HOME/Desktop/Start Remoto.command"

# Add aliases to ~/.zshrc
echo "ðŸ“ Installing aliases..."
cat >> ~/.zshrc << 'ALIASEOF'

# Remoto aliases
alias remoto-start='~/.remoto/start.sh'
alias remoto-stop='~/.remoto/stop.sh'
alias remoto-status='~/.remoto/status.sh'
alias remoto-logs='tail -f ~/.remoto/logs/*.log | tail -50'
alias remoto-autostart='~/.remoto/install-autostart.sh'

ALIASEOF

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        âœ… Installation Complete! ðŸŽ‰           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Quick Start:"
echo "  1. Double-click 'Start Remoto.command' on your Desktop"
echo "  2. OR run: remoto-start (after restarting terminal)"
echo "  3. Stream URL will auto-copy to clipboard"
echo ""
echo "Commands available:"
echo "  $SCRIPTS_DIR/start.sh           - Start all services"
echo "  $SCRIPTS_DIR/stop.sh            - Stop all services"
echo "  $SCRIPTS_DIR/status.sh          - Check status"
echo "  $SCRIPTS_DIR/install-autostart.sh - Enable auto-start on login"
echo ""
echo "Logs stored in: $HOME/.remoto/logs/"
echo ""